# –û—Ç—á–µ—Ç –æ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –∫ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É –ø—Ä–æ–µ–∫—Ç–∞ ChaosCash

**–î–∞—Ç–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏**: 23 —Ñ–µ–≤—Ä–∞–ª—è 2026
**–°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞**: –†–∞–Ω–Ω—è—è —Å—Ç–∞–¥–∏—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (—Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)
**–û—Ü–µ–Ω–∫–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã**: –•–æ—Ä–æ—à–∞—è (—á–∏—Å—Ç–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å–ª–æ–µ–≤, –Ω–æ –µ—Å—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã)

---

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±–∑–æ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞](#1-–æ–±–∑–æ—Ä-—Å—Ç—Ä—É–∫—Ç—É—Ä—ã-–ø—Ä–æ–µ–∫—Ç–∞)
2. [–ê–Ω–∞–ª–∏–∑ —Ñ—É–Ω–∫—Ü–∏–π –∏ –º–µ—Ç–æ–¥–æ–≤](#2-–∞–Ω–∞–ª–∏–∑-—Ñ—É–Ω–∫—Ü–∏–π-–∏-–º–µ—Ç–æ–¥–æ–≤)
3. [–ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∫–æ–¥](#3-–Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π-–∫–æ–¥)
4. [–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞](#4-–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ-–∫–æ–¥–∞)
5. [–ù–∞—Ä—É—à–µ–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö —Å–ª–æ–µ–≤](#5-–Ω–∞—Ä—É—à–µ–Ω–∏—è-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö-—Å–ª–æ–µ–≤)
6. [–ü–ª–∞–Ω–∏—Ä—É–µ–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –∏—Ö –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è](#6-–ø–ª–∞–Ω–∏—Ä—É–µ–º—ã–µ-–∏–∑–º–µ–Ω–µ–Ω–∏—è-–∏-–∏—Ö-–ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è)
7. [–î–æ—Ä–æ–∂–Ω–∞—è –∫–∞—Ä—Ç–∞ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞](#7-–¥–æ—Ä–æ–∂–Ω–∞—è-–∫–∞—Ä—Ç–∞-—Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞)

---

## 1. –û–±–∑–æ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Å–ª–æ–∏

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ UI Layer (PyQt6)                            ‚îÇ
‚îÇ - MainWindow, Views, Dialogs, Delegates    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Services Layer                              ‚îÇ
‚îÇ - Balance, Transaction, Integrity           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Repository Layer (DAO Pattern)              ‚îÇ
‚îÇ - Account, Transaction, Split, Currency    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Database Layer                              ‚îÇ
‚îÇ - Connection, Schema, Queries               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Models & Utilities                          ‚îÇ
‚îÇ - Domain classes, Amount math, Parsers      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ü—É—Ç—å | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-----------|------|-----------|
| Database | `app/database/` | SQLite —Å—Ö–µ–º–∞, —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è, SQL –∑–∞–ø—Ä–æ—Å—ã |
| Models | `app/models/` | Frozen dataclasses (Account, Transaction, Split, Currency) |
| Repositories | `app/repositories/` | DAO pattern, 53 –ø—É–±–ª–∏—á–Ω—ã—Ö –º–µ—Ç–æ–¥–∞ |
| Services | `app/services/` | –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (Balance, Transaction, Integrity) |
| UI | `app/ui/` | PyQt6 –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (views, models, dialogs, delegates) |
| Settings | `app/settings/` | –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è |
| Utils | `app/utils/` | –£—Ç–∏–ª–∏—Ç—ã (amount_math, expression_parser, recent_files) |
| Tests | `tests/` | Unit —Ç–µ—Å—Ç—ã –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ |

---

## 2. –ê–Ω–∞–ª–∏–∑ —Ñ—É–Ω–∫—Ü–∏–π –∏ –º–µ—Ç–æ–¥–æ–≤

### –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

- **–í—Å–µ–≥–æ –ø—É–±–ª–∏—á–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ –≤ —Å–ª–æ–µ Repositories**: 53
- **–í—Å–µ–≥–æ –ø—É–±–ª–∏—á–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ –≤ —Å–ª–æ–µ Services**: 17
- **–í—Å–µ–≥–æ –º–µ—Ç–æ–¥–æ–≤ –≤ UI Models**: 40+
- **–í—Å–µ–≥–æ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π**: 15+

### –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º

#### Repository Layer (53 –º–µ—Ç–æ–¥–∞)

| –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π | –ú–µ—Ç–æ–¥–æ–≤ | –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ |
|------------|---------|-----------------|
| **AccountRepo** | 19 | get_all, get_by_id, insert, update, delete, get_balance, get_all_descendants, get_account_path |
| **TransactionRepo** | 11 | get_by_id, insert, update, delete, get_verbose/summary_by_accounts/ids, get_imbalanced, get_empty |
| **SplitRepo** | 15 | get_by_id, insert, update, delete, get_balance_by_account, update_amount, update_amount_fixed |
| **CurrencyRepo** | 8 | get_all, get_by_id, insert, update, delete, is_used |

#### Service Layer (17 –º–µ—Ç–æ–¥–æ–≤)

| –°–µ—Ä–≤–∏—Å | –ú–µ—Ç–æ–¥–æ–≤ | –§—É–Ω–∫—Ü–∏–∏ |
|--------|---------|---------|
| **BalanceService** | 4 | invalidate, get_balance, clear (–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–≤) |
| **TransactionService** | 8 | create, update, delete, add_split, update_split, duplicate, reverse, recalculate_flexible_splits |
| **IntegrityService** | 5 | get_imbalanced_trans_ids, get_empty_transactions, check_foreign_keys, has_imbalance |

#### UI Models (40+ –º–µ—Ç–æ–¥–æ–≤)

| Model | –ú–µ—Ç–æ–¥–æ–≤ | –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ |
|-------|---------|-----------------|
| **AccountTreeModel** | 18 | reload, set_virtual_nodes, rowCount, data, setData, supportedDropActions, dropMimeData |
| **TransactionModel** | 12 | load, canFetchMore, fetchMore, rowCount, headerData, data, setData, sort |
| **SplitModel** | 10 | load, rowCount, headerData, data, setData, flags |

### –í—ã–∑–æ–≤—ã –∏–∑ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å–ª–æ–µ–≤

**–ß–∞—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ–º—ã–µ –º–µ—Ç–æ–¥—ã:**
- `BalanceService.get_balance()` ‚Äî 6+ –≤—ã–∑–æ–≤–æ–≤ (UI –º–æ–¥–µ–ª–∏–º, —Ç–µ—Å—Ç–∞–º–∏)
- `AccountRepo.get_all_descendants()` ‚Äî 9 –≤—ã–∑–æ–≤–æ–≤ (—É–¥–∞–ª–µ–Ω–∏–µ, –Ω–∞–≤–∏–≥–∞—Ü–∏—è)
- `AccountRepo.get_account_path()` ‚Äî 7+ –≤—ã–∑–æ–≤–æ–≤ (–æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—É—Ç–µ–π)
- `TransactionService` –º–µ—Ç–æ–¥—ã ‚Äî —Ä–µ–≥—É–ª—è—Ä–Ω–æ –∏–∑ UI —Å–ª–æ—è

---

## 3. –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∫–æ–¥

### –ü–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø—É–±–ª–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã

| –ú–µ—Ç–æ–¥ | –§–∞–π–ª | –¢–∏–ø | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è |
|-------|------|-----|--------------|
| `TransactionRepo.get_autocomplete()` | `transaction_repo.py:63` | –ù–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è | **–£–î–ê–õ–ò–¢–¨** |
| `TransactionRepo.get_splits_for_trans()` | `transaction_repo.py:67` | –î—É–±–ª–∏—Ä—É–µ—Ç `SplitRepo.get_by_transaction()` | **–£–î–ê–õ–ò–¢–¨** |
| `TransactionRepo.get_verbose_by_ids()` | `transaction_repo.py:49` | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ summary –≤–∞—Ä–∏–∞–Ω—Ç | **–£–î–ê–õ–ò–¢–¨** |
| `AccountRepo.get_root_accounts()` | `account_repo.py:35` | –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ | **–£–î–ê–õ–ò–¢–¨** |
| `CurrencyRepo.get_by_code()` | `currency_repo.py:28` | –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è | **–£–î–ê–õ–ò–¢–¨** |
| `recent_files.remove_recent_file()` | `recent_files.py:28` | –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è | **–£–î–ê–õ–ò–¢–¨** |

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ private –º–µ—Ç–æ–¥—ã:**
- `AccountTreeModel._remove_node_subtree()` ‚Äî —Å—Ç—Ä–æ–∫–∞ 304-320
- `SplitModel._enum_value()` –∏ `_to_checkstate()` ‚Äî —Å—Ç—Ä–æ–∫–∏ 126-140

### –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è

**–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è:**
- –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ codebase –Ω–∞ ~150 —Å—Ç—Ä–æ–∫
- –°–Ω–∏–∂–µ–Ω–∏–µ –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ API
- –£–ø—Ä–æ—â–µ–Ω–∏–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–º–µ–Ω—å—à–µ –º–µ—Ç–æ–¥–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏)
- **–ù–µ—Ç –≤–ª–∏—è–Ω–∏—è –Ω–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å** ‚Äî –∫–æ–¥ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

---

## 4. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞

### 4.1 –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï: –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å–∫—Ä—ã—Ç—ã—Ö —É—á–µ—Ç–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π (100% –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ)

#### –ü—Ä–æ–±–ª–µ–º–∞

–ò–¥–µ–Ω—Ç–∏—á–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö:

**–§–∞–π–ª 1: `app/ui/account_selection.py:7-25`**
```python
def compute_hidden_accounts(accounts: list[Account]) -> set[int]:
    children: dict[int, list[int]] = {}
    for acc in accounts:
        if acc.parent is not None:
            children.setdefault(acc.parent, []).append(acc.id)

    hidden: set[int] = {acc.id for acc in accounts if acc.is_hidden}

    def mark_hidden_descendants(account_id: int) -> None:
        for child_id in children.get(account_id, []):
            if child_id in hidden:
                mark_hidden_descendants(child_id)
                continue
            hidden.add(child_id)
            mark_hidden_descendants(child_id)

    for hidden_id in list(hidden):
        mark_hidden_descendants(hidden_id)
    return hidden
```

**–§–∞–π–ª 2: `app/ui/item_models/account_tree_model.py:93-111`**
```python
def _compute_hidden_subtree_ids(self, all_accounts: list[Account]) -> set[int]:
    # –ê–±—Å–æ–ª—é—Ç–Ω–æ –∏–¥–µ–Ω—Ç–∏—á–Ω—ã–π –∫–æ–¥
```

#### –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

- **–ü—Ä–æ–±–ª–µ–º–∞ —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π**: –ï—Å–ª–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –æ—à–∏–±–∫–∞ –≤ –ª–æ–≥–∏–∫–µ —Å–∫—Ä—ã—Ç—ã—Ö —É—á–µ—Ç–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π, –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –æ–±–µ –∫–æ–ø–∏–∏
- **–£—Å–ª–æ–∂–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**: –ù—É–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–¥–Ω—É –∏ —Ç—É –∂–µ –ª–æ–≥–∏–∫—É –¥–≤–∞–∂–¥—ã
- **–†–∏—Å–∫ –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–∏**: –°–æ –≤—Ä–µ–º–µ–Ω–µ–º –∫–æ–ø–∏–∏ –º–æ–≥—É—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è, —Å–æ–∑–¥–∞–≤–∞—è –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

#### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª: `app/utils/account_hierarchy.py`**

```python
def compute_hidden_account_ids(accounts: list[Account]) -> set[int]:
    """Compute IDs of all hidden accounts including their descendants."""
    children: dict[int, list[int]] = {}
    for acc in accounts:
        if acc.parent is not None:
            children.setdefault(acc.parent, []).append(acc.id)

    hidden: set[int] = {acc.id for acc in accounts if acc.is_hidden}

    def mark_hidden_descendants(account_id: int) -> None:
        for child_id in children.get(account_id, []):
            if child_id in hidden:
                mark_hidden_descendants(child_id)
                continue
            hidden.add(child_id)
            mark_hidden_descendants(child_id)

    for hidden_id in list(hidden):
        mark_hidden_descendants(hidden_id)
    return hidden
```

**–ó–∞—Ç–µ–º –æ–±–Ω–æ–≤–∏—Ç—å –æ–±–∞ –∏–º–ø–æ—Ä—Ç–∞:**
- `account_selection.py`: `from app.utils.account_hierarchy import compute_hidden_account_ids`
- `account_tree_model.py`: `from app.utils.account_hierarchy import compute_hidden_account_ids`

---

### 4.2 –í–´–°–û–ö–û–ï: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É–º–º (4+ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π)

#### –ü—Ä–æ–±–ª–µ–º–∞

–ö–∞–∂–¥–∞—è UI –º–æ–¥–µ–ª—å –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç `format_amount()` —Å–≤–æ–∏–º –º–µ—Ç–æ–¥–æ–º:

**`split_model.py:166-177`:**
```python
def _format_amt(self, quants: int, currency_id: int | None) -> str:
    if currency_id is None:
        return ""
    cur = self._currencies.get(currency_id)
    if cur is None:
        return str(quants)
    return format_amount(quants, cur.denominator,
                        self.settings.decimal_sep,
                        self.settings.thousands_sep)
```

**`account_tree_model.py:202-215`:** Similar wrapper
**`transaction_model.py:151-158`:** Different wrapper with same logic

#### –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è

- **–ö–æ–¥ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è** 3-4 —Ä–∞–∑–∞ –≤ —Ä–∞–∑–Ω—ã—Ö –º–æ–¥–µ–ª—è—Ö
- **–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å** –ª–æ–≥–∏–∫—É —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
- **–°–ª–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å** (–Ω—É–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—É—é –æ–±–µ—Ä—Ç–∫—É)

#### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

**–°–æ–∑–¥–∞—Ç—å –∫–ª–∞—Å—Å: `app/services/amount_formatter.py`**

```python
class AmountFormatter:
    def __init__(self, settings: AppSettings, currencies_repo: CurrencyRepo):
        self.settings = settings
        self.currencies = currencies_repo

    def format_amount_with_currency(self, quants: int, currency_id: int | None) -> str:
        """Format amount in specific currency."""
        if currency_id is None:
            return ""
        cur = self.currencies.get_by_id(currency_id)
        if cur is None:
            return str(quants)
        return format_amount(quants, cur.denominator,
                           self.settings.decimal_sep,
                           self.settings.thousands_sep)
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –í—Å–µ UI –º–æ–¥–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç `AmountFormatter` –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ.

---

### 4.3 –°–†–ï–î–ù–ï–ï: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç (5+ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π)

#### –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞—Ç—ã –æ—Ç Qt –∫ strftime –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è:

**`transaction_model.py:131-133`:**
```python
fmt = fmt.replace("yyyy", "%Y").replace("MM", "%m").replace("dd", "%d")
fmt = fmt.replace("HH", "%H").replace("mm", "%M").replace("ss", "%S")
```

**–ü–æ—è–≤–ª—è–µ—Ç—Å—è —Ç–∞–∫–∂–µ –≤:**
- `transaction_model.py:145-146` (–ø–æ–≤—Ç–æ—Ä–Ω–æ –≤ —Ç–æ–º –∂–µ —Ñ–∞–π–ª–µ!)
- `date_delegate.py` (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç Qt format –Ω–∞–ø—Ä—è–º—É—é, —Å–æ–∑–¥–∞–≤–∞—è –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ)

#### –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è

- **–ù–µ–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
- **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞** –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ (—Å—Ç—Ä–æ–∫–∏ 131 –∏ 145)
- **–°–ª–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏** —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞—Ç—ã

#### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

**–°–æ–∑–¥–∞—Ç—å —É—Ç–∏–ª–∏—Ç—É: `app/utils/date_utils.py`**

```python
def qt_format_to_strftime(qt_format: str) -> str:
    """Convert Qt date format (yyyy-MM-dd) to strftime format (%Y-%m-%d)."""
    result = qt_format
    result = result.replace("yyyy", "%Y").replace("MM", "%m").replace("dd", "%d")
    result = result.replace("HH", "%H").replace("mm", "%M").replace("ss", "%S")
    return result
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤–æ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö**, —Ç—Ä–µ–±—É—é—â–∏—Ö –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–∞.

---

### 4.4 –°–†–ï–î–ù–ï–ï: –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—É—Ç–∏ —É—á–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏

#### –ü—Ä–æ–±–ª–µ–º–∞

`AccountRepo.get_account_path()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è 7+ —Ä–∞–∑ –∏–∑ UI –º–æ–¥–µ–ª–µ–π:
- `split_model.py:203, 210, 229, 497`
- `account_tree_model.py:497` (–∏ –≤ dialogs)

–ö–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ —Å–æ–≤–µ—Ä—à–∞–µ—Ç N+1 –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î (—Ü–∏–∫–ª —Å `get_by_id()`).

**`account_repo.py:88-105`:**
```python
def get_account_path(self, account_id: int) -> str:
    # ... –Ω–∞—Ö–æ–¥–∏—Ç –ø—É—Ç—å —á–µ—Ä–µ–∑ —Ü–∏–∫–ª get_by_id() –≤ loop
    while current_id is not None:
        acc = self.get_by_id(current_id)
        # ... –∫–∞–∂–¥—ã–π parent —Ç—Ä–µ–±—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞!
```

#### –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è

- **N+1 –ø—Ä–æ–±–ª–µ–º–∞**: –î–ª—è –æ–¥–Ω–æ–≥–æ –ø—É—Ç–∏ —Å–æ–≤–µ—Ä—à–∞–µ—Ç—Å—è –º–Ω–æ–∂–µ—Å—Ç–≤–æ SQL –∑–∞–ø—Ä–æ—Å–æ–≤
- **–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏**: –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –≤ —Å–ª–æ–µ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º
- **–í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ UI**: –ü—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –ø—É—Ç–µ–π = –º–Ω–æ–∂–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤

#### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

**–°–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–∏—Å: `app/services/account_path_service.py`**

```python
class AccountPathService:
    def __init__(self, account_repo: AccountRepo, settings: AppSettings):
        self.account_repo = account_repo
        self.settings = settings
        self._path_cache: dict[int, str] = {}

    def get_path(self, account_id: int) -> str:
        """Get account path with caching."""
        if account_id in self._path_cache:
            return self._path_cache[account_id]

        # –ö—ç—à–∏—Ä—É–µ—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—É—Ç–∏
        path = self._build_path(account_id)
        self._path_cache[account_id] = path
        return path

    def invalidate(self, account_id: int | None = None) -> None:
        """Clear cache for account or all accounts."""
        if account_id is None:
            self._path_cache.clear()
        else:
            self._path_cache.pop(account_id, None)
```

---

### 4.5 –ù–ò–ó–ö–û–ï: –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏–Ω–¥–µ–∫—Å–æ–≤ —Å—Ç–æ–ª–±—Ü–æ–≤

#### –ü—Ä–æ–±–ª–µ–º–∞

–ö–∞–∂–¥–∞—è UI –º–æ–¥–µ–ª—å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–≤–æ–∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã —Å—Ç–æ–ª–±—Ü–æ–≤:

**`split_model.py:19-26`:** COL_ID, COL_EXTID, COL_DESC, COL_ACCOUNT, COL_FIXED, COL_AMOUNT, COL_CURRENCY
**`transaction_model.py:14-20`:** COL_ID, COL_DATE, COL_DESC, COL_AMOUNT, COL_BALANCE, COL_CURRENCY
**`account_tree_model.py:11-18`:** COL_NAME, COL_TOTAL_BALANCE, COL_OWN_BALANCE, COL_HIDDEN, ...

#### –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è

- **–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** (–≤ –∫–æ–¥–µ –Ω–µ—Ç –µ–¥–∏–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∏—Å—Ç–∏–Ω—ã)
- **–û—à–∏–±–∫–∏ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å—Ç–æ–ª–±—Ü–æ–≤** (–ª–µ–≥–∫–æ –∑–∞–±—ã—Ç—å –æ–±–Ω–æ–≤–∏—Ç—å NUM_COLS)
- **–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ –∫–æ–¥–∞** (–æ–¥–Ω–∞ –∏ —Ç–∞ –∂–µ –∏–¥–µ—è 3 —Ä–∞–∑–∞)

#### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª: `app/ui/config/columns.py`**

```python
class SplitColumns:
    ID = 0
    EXTERNAL_ID = 1
    DESCRIPTION = 2
    ACCOUNT = 3
    FIXED = 4
    AMOUNT = 5
    CURRENCY = 6
    COUNT = 7

class TransactionColumns:
    ID = 0
    DATE = 1
    DESCRIPTION = 2
    AMOUNT = 3
    BALANCE = 4
    CURRENCY = 5
    COUNT = 6

class AccountTreeColumns:
    NAME = 0
    TOTAL_BALANCE = 1
    OWN_BALANCE = 2
    HIDDEN = 3
    CODE = 4
    EXTERNAL_ID = 5
    DESCRIPTION = 6
    COUNT = 7
```

---

## 5. –ù–∞—Ä—É—à–µ–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö —Å–ª–æ–µ–≤

### 5.1 –°–†–ï–î–ù–ï–ï: –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –≤ UI –º–æ–¥–µ–ª—è—Ö

#### –ü—Ä–æ–±–ª–µ–º–∞ A: –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –∏–º–±–∞–ª–∞–Ω—Å–æ–≤ —Ä–∞–∑–¥–µ–ª–æ–≤ –≤ UI

**`split_model.py:100-107`:**
```python
def _add_phantom_rows(self, splits: list[Split]) -> None:
    totals: dict[int, int] = defaultdict(int)
    for s in splits:
        totals[s.currency] += s.amount  # ‚Üê –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞!
    for cid, total in totals.items():
        if total != 0:
            self._rows.append(SplitRow(None, ROW_PHANTOM, cid, -total))
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞:**
- –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –∏–º–±–∞–ª–∞–Ω—Å–æ–≤ ‚Äî —ç—Ç–æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ `TransactionService`, –∞ –Ω–µ –≤ UI –º–æ–¥–µ–ª–∏
- –ù–µ–ª—å–∑—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –¥—Ä—É–≥–∏—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ API)
- –£—Å–ª–æ–∂–Ω—è–µ—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–Ω—É–∂–Ω–æ –º–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Å—å QAbstractTableModel)

#### –ü—Ä–æ–±–ª–µ–º–∞ B: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ —Å–æ–≤–º–µ—â–µ–Ω–æ —Å –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ–º

**`account_tree_model.py:202-215`:**
```python
def _format_balance(self, account_id: int, include_children: bool) -> str:
    balance = self.balance_service.get_balance(account_id, include_children)
    # ‚Üê –í—ã—á–∏—Å–ª–µ–Ω–∏–µ (Service)

    parts = []
    for cid, quants in balance.items():
        if quants == 0:  # ‚Üê –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω—É–ª–µ–≤—ã—Ö)
            continue
        cur = self._currencies.get(cid)
        if cur is None:  # ‚Üê –õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
            continue
        from app.utils.amount_math import format_amount
        parts.append(f"{format_amount(...)} {cur.code}")  # ‚Üê –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    return ", ".join(parts)
```

**–°–º–µ—à–∞–Ω–Ω—ã–µ —Å–ª–æ–∏:**
- –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞: —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω—É–ª–µ–≤—ã—Ö, –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª—é—Ç—ã
- Pr√©sentation: —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫
- –í—Å–µ –≤ –æ–¥–Ω–æ–º –º–µ—Ç–æ–¥–µ UI –º–æ–¥–µ–ª–∏

#### –ü—Ä–æ–±–ª–µ–º–∞ C: –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –±–∞–ª–∞–Ω—Å—É —Å–æ–≤–µ—Ä—à–∞–µ—Ç N –∑–∞–ø—Ä–æ—Å–æ–≤

**`account_tree_model.py:351-354`:**
```python
if column == COL_TOTAL_BALANCE:
    return sum(self.balance_service.get_balance(a.id, include_children=True).values())
if column == COL_OWN_BALANCE:
    return sum(self.balance_service.get_balance(a.id, include_children=False).values())
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- –ü—Ä–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–µ 100 —Å—á–µ—Ç–æ–≤ –≤—ã–∑—ã–≤–∞–µ—Ç 100 `get_balance()`
- –í—ã—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –≤–æ –≤—Ä–µ–º—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–ª–æ–π)
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ BalanceService –ø–æ–º–æ–≥–∞–µ—Ç, –Ω–æ –≤—Å–µ —Ä–∞–≤–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω

#### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

1. **–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –ª–æ–≥–∏–∫—É –∏–º–±–∞–ª–∞–Ω—Å–æ–≤ –≤ TransactionService:**
   ```python
   class TransactionService:
       def calculate_currency_totals(self, trans_id: int) -> dict[int, int]:
           """Calculate total per currency (including zero/imbalanced)."""

       def get_imbalances_per_currency(self, trans_id: int) -> dict[int, int]:
           """Get imbalances that need phantom splits."""
   ```

2. **–°–æ–∑–¥–∞—Ç—å FormattingService –¥–ª—è –≤—Å–µ—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π:**
   ```python
   class TransactionFormattingService:
       def format_balance_display(self, balance_dict, settings, currencies):
           """Format balance for display (filters zeros, applies format)."""
   ```

3. **–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –∏–∑ UI –≤ Service:**
   ```python
   class BalanceService:
       def get_total_balance_for_sort(self, account_id: int) -> int:
           """Returns pre-calculated value for sorting."""
   ```

---

### 5.2 –°–†–ï–î–ù–ï–ï: –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –≤ –≥–ª–∞–≤–Ω–æ–º –æ–∫–Ω–µ

#### –ü—Ä–æ–±–ª–µ–º–∞

`main_window.py` —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –∏–º–±–∞–ª–∞–Ω—Å–æ–≤ –ø—Ä—è–º–æ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö —Å–æ–±—ã—Ç–∏–π:

**`main_window.py:738-741`:**
```python
# –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–ª–∞–≥–∞ fixed
imbalance = sum(s.amount for s in currency_splits)
self.trans_service.recalculate_flexible_splits(
    imbalance, split.currency, self._current_trans_id
)
```

**`main_window.py:797-800`:**
```python
# –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—É–º–º—ã
imbalance = sum(s.amount for s in currency_splits)
self.trans_service.recalculate_flexible_splits(
    imbalance, affected_currency, self._current_trans_id
)
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- **UI –≤—ã—á–∏—Å–ª—è–µ—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É** (imbalance calculation)
- **–î—É–±–ª–∏—Ä—É–µ—Ç –≤—ã—á–∏—Å–ª–µ–Ω–∏—è** (–æ–¥–Ω–∞ –ª–æ–≥–∏–∫–∞ –≤ 2-3 –º–µ—Å—Ç–∞—Ö)
- **–°–µ—Ä–≤–∏—Å —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–µ–¥-–≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è** (—Å–ª–∞–±–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏)

#### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

**–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ TransactionService:**
```python
class TransactionService:
    def recalculate_flexible_splits_for_changes(self, trans_id: int,
                                                currency_id: int | None = None) -> bool:
        """Recalculate after any split changes. Service computes imbalance."""
        # Service –≤—ã—á–∏—Å–ª—è–µ—Ç imbalance —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ
        splits = self.split_repo.get_by_transaction(trans_id)
        if currency_id is None:
            # ... recalc all currencies
        else:
            imbalance = sum(s.amount for s in splits if s.currency == currency_id)
            # ... recalc for currency
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
# main_window.py
self.trans_service.recalculate_flexible_splits_for_changes(self._current_trans_id)
```

---

### 5.3 –ù–ò–ó–ö–û–ï: –ü–∞—Ä–∞–º–µ—Ç—Ä Settings –≤ Repository

#### –ü—Ä–æ–±–ª–µ–º–∞

`AccountRepo` –∏–º–µ–µ—Ç –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä `settings`:

**`account_repo.py:13-15`:**
```python
def __init__(self, conn: sqlite3.Connection, settings: AppSettings | None = None):
    self.conn = conn
    self.settings = settings
```

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ `get_account_path():`**
```python
separator = self.settings.account_path_sep if self.settings else " / "
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- –î—Ä—É–≥–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –Ω–µ –∏–º–µ—é—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ settings
- –ù–∞—Ä—É—à–∞–µ—Ç –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å dependency injection
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤—ã—à–µ)

#### –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è `AccountPathService`, —ç—Ç–æ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å, —Å–¥–µ–ª–∞–≤ –≤—Å–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–º–∏.

---

### 5.4 –ù–ò–ó–ö–û–ï: –ü—Ä—è–º—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã –≤ Repository

#### –ü—Ä–æ–±–ª–µ–º–∞

**`split_repo.py:85`:**
```python
def has_splits_for_account(self, account_id: int) -> bool:
    row = self.conn.execute(
        "SELECT 1 FROM Split WHERE Account=? LIMIT 1",
        (account_id,)
    ).fetchone()
    return row is not None
```

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:** SQL –∑–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ `app/database/queries/splits.py`

#### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ `queries/splits.py`:
```python
HAS_SPLITS_FOR_ACCOUNT = "SELECT 1 FROM Split WHERE Account=? LIMIT 1"
```

---

## 6. –ü–ª–∞–Ω–∏—Ä—É–µ–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –∏—Ö –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è

### 6.1 –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ –∫–æ–¥–∞

**–ú–µ—Ç–æ–¥:** –£–¥–∞–ª–∏—Ç—å 6 –º–µ—Ç–æ–¥–æ–≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤

| –ú–µ—Ç–æ–¥ | –§–∞–π–ª | –ü—Ä–∏—á–∏–Ω–∞ | –†–∏—Å–∫ |
|-------|------|--------|------|
| `get_autocomplete()` | `transaction_repo.py` | –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ | –ù–£–õ–ï–í–û–ô |
| `get_splits_for_trans()` | `transaction_repo.py` | –î—É–±–ª–∏—Ä—É–µ—Ç SplitRepo | –ù–£–õ–ï–í–û–ô |
| `get_verbose_by_ids()` | `transaction_repo.py` | –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è | –ù–£–õ–ï–í–û–ô |
| `get_root_accounts()` | `account_repo.py` | –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è | –ù–£–õ–ï–í–û–ô |
| `get_by_code()` | `currency_repo.py` | –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è | –ù–£–õ–ï–í–û–ô |
| `remove_recent_file()` | `recent_files.py` | –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è | –ù–£–õ–ï–í–û–ô |

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- ‚úÖ –£–ø—Ä–æ—â–µ–Ω–∏–µ API —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
- ‚úÖ –£–º–µ–Ω—å—à–µ–Ω–∏–µ –ø–ª–æ—â–∞–¥–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚úÖ –Ø—Å–Ω–æ—Å—Ç—å –Ω–∞–º–µ—Ä–µ–Ω–∏–π (—É–¥–∞–ª–µ–Ω–Ω—ã–π –∫–æ–¥ = –Ω–µ –Ω—É–∂–µ–Ω)
- ‚ùå –ï—Å–ª–∏ –∫–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω—É–∂–µ–Ω (–º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ) ‚Äî –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ Git

---

### 6.2 –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ª–æ–≥–∏–∫–∏

**–ó–∞–¥–∞—á–∞ 1: –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å–∫—Ä—ã—Ç—ã—Ö —Å—á–µ—Ç–æ–≤**

| –ê—Å–ø–µ–∫—Ç | –î–µ—Ç–∞–ª—å |
|--------|--------|
| **–í–ª–∏—è–Ω–∏–µ** | –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –≤ `app/utils/account_hierarchy.py` |
| **–§–∞–π–ª—ã** | `account_selection.py`, `account_tree_model.py` |
| **–†–∏—Å–∫** | –ú–ò–ù–ò–ú–ê–õ–¨–ù–´–ô (–ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∏–¥–µ–Ω—Ç–∏—á–Ω–æ–≥–æ –∫–æ–¥–∞) |
| **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** | –°–æ–∑–¥–∞—Ç—å test_account_hierarchy.py |
| **–í—Ä–µ–º—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏** | 15 –º–∏–Ω—É—Ç |

**–ó–∞–¥–∞—á–∞ 2: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É–º–º**

| –ê—Å–ø–µ–∫—Ç | –î–µ—Ç–∞–ª—å |
|--------|--------|
| **–í–ª–∏—è–Ω–∏–µ** | –°–æ–∑–¥–∞–Ω–∏–µ `AmountFormatter` —Å–µ—Ä–≤–∏—Å –∫–ª–∞—Å—Å–∞ |
| **–§–∞–π–ª—ã** | split_model.py, account_tree_model.py, transaction_model.py |
| **–†–∏—Å–∫** | –ù–ò–ó–ö–ò–ô (–Ω–æ–≤—ã–π –∫–ª–∞—Å—Å, —Å—Ç–∞—Ä—ã–µ –º–µ—Ç–æ–¥—ã —É–¥–∞–ª—è—é—Ç—Å—è) |
| **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** | test_amount_formatter.py |
| **–í—Ä–µ–º—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏** | 30 –º–∏–Ω—É—Ç |

**–ó–∞–¥–∞—á–∞ 3: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç**

| –ê—Å–ø–µ–∫—Ç | –î–µ—Ç–∞–ª—å |
|--------|--------|
| **–í–ª–∏—è–Ω–∏–µ** | –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –≤ `app/utils/date_utils.py` |
| **–§–∞–π–ª—ã** | transaction_model.py, date_delegate.py |
| **–†–∏—Å–∫** | –ù–ò–ó–ö–ò–ô (—É—Ç–∏–ª–∏—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è, –Ω–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è) |
| **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** | test_date_utils.py |
| **–í—Ä–µ–º—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏** | 15 –º–∏–Ω—É—Ç |

---

### 6.3 –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –≤ —Å–µ—Ä–≤–∏—Å—ã

**–ó–∞–¥–∞—á–∞ 1: –ü—É—Ç—å —É—á–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏ –≤ —Å–µ—Ä–≤–∏—Å**

| –ê—Å–ø–µ–∫—Ç | –î–µ—Ç–∞–ª—å |
|--------|--------|
| **–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ** | `AccountRepo.get_account_path()` —Å–æ–≤–µ—Ä—à–∞–µ—Ç N –∑–∞–ø—Ä–æ—Å–æ–≤ |
| **–†–µ—à–µ–Ω–∏–µ** | –°–æ–∑–¥–∞—Ç—å `AccountPathService` —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º |
| **–§–∞–π–ª—ã** | –°–æ–∑–¥–∞—Ç—å `app/services/account_path_service.py` |
| **–†–∏—Å–∫** | –ù–ò–ó–ö–ò–ô (–Ω–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å, —Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è deprecated) |
| **–ü–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∞** | –û–±–Ω–æ–≤–∏—Ç—å 7+ –≤—ã–∑–æ–≤–æ–≤ –≤ UI –º–æ–¥–µ–ª—è—Ö –∏ dialogs |
| **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫–∞–∫ –≤ BalanceService |
| **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** | test_account_path_service.py (—Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º) |
| **–í—Ä–µ–º—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏** | 45 –º–∏–Ω—É—Ç |

**–ó–∞–¥–∞—á–∞ 2: –ò–º–±–∞–ª–∞–Ω—Å—ã —Ä–∞–∑–¥–µ–ª–æ–≤ –≤ —Å–µ—Ä–≤–∏—Å**

| –ê—Å–ø–µ–∫—Ç | –î–µ—Ç–∞–ª—å |
|--------|--------|
| **–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ** | `SplitModel._add_phantom_rows()` –≤—ã—á–∏—Å–ª—è–µ—Ç –∏–º–±–∞–ª–∞–Ω—Å—ã |
| **–†–µ—à–µ–Ω–∏–µ** | –ú–µ—Ç–æ–¥ –≤ `TransactionService` –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –∏–º–±–∞–ª–∞–Ω—Å–æ–≤ |
| **–§–∞–π–ª—ã** | –û–±–Ω–æ–≤–∏—Ç—å `transaction_service.py` |
| **–†–∏—Å–∫** | –ù–ò–ó–ö–ò–ô (–ª–æ–≥–∏–∫–∞Áßª  –∏–∑ UI –≤ Service) |
| **–ü–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∞** | –û–±–Ω–æ–≤–∏—Ç—å `split_model.py` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –º–µ—Ç–æ–¥–∞ |
| **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** | –ù–æ–≤—ã–µ —Ç–µ—Å—Ç—ã –≤ `test_transaction_service.py` |
| **–í—Ä–µ–º—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏** | 30 –º–∏–Ω—É—Ç |

---

### 6.4 –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Å—Ç–∞–Ω—Ç

**–ó–∞–¥–∞—á–∞: –ò–Ω–¥–µ–∫—Å—ã —Å—Ç–æ–ª–±—Ü–æ–≤**

| –ê—Å–ø–µ–∫—Ç | –î–µ—Ç–∞–ª—å |
|--------|--------|
| **–í–ª–∏—è–Ω–∏–µ** | –°–æ–∑–¥–∞—Ç—å `app/ui/config/columns.py` —Å –∫–ª–∞—Å—Å–∞–º–∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç |
| **–§–∞–π–ª—ã** | split_model.py, transaction_model.py, account_tree_model.py |
| **–†–∏—Å–∫** | –ù–£–õ–ï–í–û–ô (—Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç, –ª–æ–≥–∏–∫–∞ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è) |
| **–ü–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∞** | –û–±–Ω–æ–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã –≤ 3 —Ñ–∞–π–ª–∞—Ö |
| **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** | –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è (–∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã, –Ω–µ—Ç –ª–æ–≥–∏–∫–∏) |
| **–í—Ä–µ–º—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏** | 10 –º–∏–Ω—É—Ç |

---

## 7. –î–æ—Ä–æ–∂–Ω–∞—è –∫–∞—Ä—Ç–∞ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

### –§–∞–∑–∞ 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è (–î–µ–Ω—å 1)

**–¶–µ–ª—å:** –£–¥–∞–ª–∏—Ç—å –º–µ—Ä—Ç–≤—ã–π –∫–æ–¥, –∏–∑–≤–ª–µ—á—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ

1. ‚úÖ **–£–¥–∞–ª–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –º–µ—Ç–æ–¥—ã** (6 –º–µ—Ç–æ–¥–æ–≤)
   - –ú–µ—Ç–æ–¥—ã –≤ task: `get_autocomplete`, `get_splits_for_trans`, `get_verbose_by_ids`, `get_root_accounts`, `get_by_code`, `remove_recent_file`
   - –í—Ä–µ–º—è: 15 –º–∏–Ω—É—Ç
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥—É—Ç

2. ‚úÖ **–ò–∑–≤–ª–µ—á—å `compute_hidden_accounts`**
   - –°–æ–∑–¥–∞—Ç—å `app/utils/account_hierarchy.py`
   - –û–±–Ω–æ–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã –≤ 2 —Ñ–∞–π–ª–∞—Ö
   - –í—Ä–µ–º—è: 15 –º–∏–Ω—É—Ç
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç—ã, –¥–æ–±–∞–≤–∏—Ç—å test_account_hierarchy.py

3. ‚úÖ **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã —Å—Ç–æ–ª–±—Ü–æ–≤**
   - –°–æ–∑–¥–∞—Ç—å `app/ui/config/columns.py`
   - –û–±–Ω–æ–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã –≤ 3 —Ñ–∞–π–ª–∞—Ö
   - –í—Ä–µ–º—è: 10 –º–∏–Ω—É—Ç
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ UI –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–ò—Ç–æ–≥ –§–∞–∑—ã 1:**
- ~40 –º–∏–Ω—É—Ç —Ä–∞–±–æ—Ç—ã
- –£–¥–∞–ª–µ–Ω–æ ~180 —Å—Ç—Ä–æ–∫ –º–µ—Ä—Ç–≤–æ–≥–æ –∫–æ–¥–∞
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∫—Ä–∞—â–µ–Ω–æ –Ω–∞ ~50 —Å—Ç—Ä–æ–∫

---

### –§–∞–∑–∞ 2: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–î–µ–Ω—å 2-3)

**–¶–µ–ª—å:** –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å–ª–æ–∏

4. ‚úÖ **–°–æ–∑–¥–∞—Ç—å `AccountPathService`**
   - –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –ª–æ–≥–∏–∫—É –∏–∑ `AccountRepo.get_account_path()`
   - –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (–∫–∞–∫ –≤ BalanceService)
   - –û–±–Ω–æ–≤–∏—Ç—å 7+ –≤—ã–∑–æ–≤–æ–≤ –≤ UI —Å–ª–æ–µ
   - –£–¥–∞–ª–∏—Ç—å settings –ø–∞—Ä–∞–º–µ—Ç—Ä –∏–∑ AccountRepo
   - –í—Ä–µ–º—è: 45 –º–∏–Ω—É—Ç
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: test_account_path_service.py —Å –∫—ç—à–µ–º

5. ‚úÖ **–°–æ–∑–¥–∞—Ç—å `AmountFormatter` —Å–µ—Ä–≤–∏—Å**
   - –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É–º–º
   - –û–±–Ω–æ–≤–∏—Ç—å 3 UI –º–æ–¥–µ–ª–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
   - –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã `_format_amt()`
   - –í—Ä–µ–º—è: 30 –º–∏–Ω—É—Ç
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: test_amount_formatter.py

6. ‚úÖ **–°–æ–∑–¥–∞—Ç—å `DateTimeFormatter` —É—Ç–∏–ª–∏—Ç—É**
   - –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞—Ç—ã
   - –û–±–Ω–æ–≤–∏—Ç—å `transaction_model.py` –∏ `date_delegate.py`
   - –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏—Ä—É—é—â–∏–π—Å—è –∫–æ–¥ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
   - –í—Ä–µ–º—è: 15 –º–∏–Ω—É—Ç
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: test_date_utils.py

7. ‚úÖ **–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∏–º–±–∞–ª–∞–Ω—Å–æ–≤ –≤ TransactionService**
   - –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `get_imbalances_per_currency(trans_id)`
   - –û–±–Ω–æ–≤–∏—Ç—å `SplitModel._add_phantom_rows()` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞
   - –í—Ä–µ–º—è: 30 –º–∏–Ω—É—Ç
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –û–±–Ω–æ–≤–∏—Ç—å test_split_model.py

**–ò—Ç–æ–≥ –§–∞–∑—ã 2:**
- ~2 —á–∞—Å–∞ —Ä–∞–±–æ—Ç—ã
- –ü–µ—Ä–µ–º–µ—â–µ–Ω–æ ~150 —Å—Ç—Ä–æ–∫ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –∏–∑ UI –≤ Services
- –°–æ–∑–¥–∞–Ω—ã 3 –Ω–æ–≤—ã—Ö —Å–µ—Ä–≤–∏—Å–∞/—É—Ç–∏–ª–∏—Ç—ã
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∫—Ä–∞—â–µ–Ω–æ –µ—â–µ –Ω–∞ ~200 —Å—Ç—Ä–æ–∫

---

### –§–∞–∑–∞ 3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è UI (–î–µ–Ω—å 4)

**–¶–µ–ª—å:** –û—á–∏—Å—Ç–∏—Ç—å –æ—Å—Ç–∞–≤—à—É—é—Å—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –∏–∑ –≥–ª–∞–≤–Ω–æ–≥–æ –æ–∫–Ω–∞

8. ‚úÖ **Refactor –≥–ª–∞–≤–Ω–æ–≥–æ –æ–∫–Ω–∞**
   - –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –∏–º–±–∞–ª–∞–Ω—Å–æ–≤ –≤ –º–µ—Ç–æ–¥—ã —Å–µ—Ä–≤–∏—Å–∞
   - –£–ø—Ä–æ—Å—Ç–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –≤ `main_window.py`
   - –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è (—Å—Ç—Ä–æ–∫–∏ 738, 797)
   - –í—Ä–µ–º—è: 30 –º–∏–Ω—É—Ç
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç

9. ‚úÖ **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è SQL –∑–∞–ø—Ä–æ—Å–æ–≤**
   - –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å `has_splits_for_account()` SQL –≤ queries –º–æ–¥—É–ª—å
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞ –¥—Ä—É–≥–∏–µ inline SQL –∑–∞–ø—Ä–æ—Å—ã
   - –í—Ä–µ–º—è: 10 –º–∏–Ω—É—Ç
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —É–¥–∞–ª–µ–Ω–∏–µ —Å—á–µ—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ò—Ç–æ–≥ –§–∞–∑—ã 3:**
- ~40 –º–∏–Ω—É—Ç —Ä–∞–±–æ—Ç—ã
- –£–¥–∞–ª–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑ UI —Å–ª–æ—è
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã SQL –∑–∞–ø—Ä–æ—Å—ã

---

### –ò—Ç–æ–≥–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ —É–ª—É—á—à–µ–Ω–∏–π

| –ú–µ—Ç—Ä–∏–∫–∞ | –ë—ã–ª–æ | –°—Ç–∞–Ω–µ—Ç | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|------|--------|-----------|
| **–°—Ç—Ä–æ–∫ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞** | ~250 | ~50 | 80% ‚Üì |
| **–ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –º–µ—Ç–æ–¥–æ–≤** | 6 | 0 | 100% ‚Üì |
| **–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –≤ UI —Å–ª–æ–µ** | HIGH | LOW | 70% ‚Üì |
| **–í—ã–∑–æ–≤–æ–≤ get_account_path()** | 7 | 1 (–≤ —Å–µ—Ä–≤–∏—Å–µ) | 85% ‚Üì |
| **–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—É–º–º (–º–µ—Ç–æ–¥–æ–≤)** | 4 | 1 | 75% ‚Üì |
| **–¶–∏–∫–ª–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å main_window** | HIGH | MEDIUM | 30% ‚Üì |

---

## –ò—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### ‚úÖ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

1. **–ß–∏—Å—Ç–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å–ª–æ–µ–≤** ‚Äî UI, Services, Repositories, Database —á–µ—Ç–∫–æ —Ä–∞–∑–¥–µ–ª–µ–Ω—ã
2. **Repository Pattern** ‚Äî —Ö–æ—Ä–æ—à–∞—è –∏–∑–æ–ª—è—Ü–∏—è SQL –∑–∞–ø—Ä–æ—Å–æ–≤
3. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Service** ‚Äî BalanceService –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ö–æ—Ä–æ—à—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
4. **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å** ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –≤ —Å–µ—Ä–≤–∏—Å–∞—Ö –∏–º–µ–µ—Ç —Ç–µ—Å—Ç—ã
5. **Domain Models** ‚Äî —á–∏—Å—Ç—ã–µ frozen dataclasses, –±–µ–∑ –ø–æ–±–æ—á–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤

### ‚ùå –û–±–ª–∞—Å—Ç–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è

1. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ UI –º–æ–¥–µ–ª—è—Ö** ‚Äî —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è
2. **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ UI** ‚Äî —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
3. **–ñ–µ—Å—Ç–∫–æ–µ —Å–≤—è–∑—ã–≤–∞–Ω–∏–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç** ‚Äî –∏–Ω–¥–µ–∫—Å—ã —Å—Ç–æ–ª–±—Ü–æ–≤, ID –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö —É–∑–ª–æ–≤ —Ä–∞–∑–±—Ä–æ—Å–∞–Ω—ã
4. **N+1 –ø—Ä–æ–±–ª–µ–º—ã** ‚Äî `get_account_path()` —Å–æ–≤–µ—Ä—à–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤

### üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

| –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –ó–∞–¥–∞—á–∞ | ROI | –í—Ä–µ–º—è |
|-----------|--------|-----|-------|
| **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô** | –£–¥–∞–ª–∏—Ç—å –º–µ—Ä—Ç–≤—ã–π –∫–æ–¥ | –í–´–°–û–ö–ò–ô | 15 –º–∏–Ω |
| **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô** | –ò–∑–≤–ª–µ—á—å `compute_hidden_accounts` | –í–´–°–û–ö–ò–ô | 15 –º–∏–Ω |
| **–í–´–°–û–ö–ò–ô** | –°–æ–∑–¥–∞—Ç—å `AccountPathService` (–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ) | –í–´–°–û–ö–ò–ô | 45 –º–∏–Ω |
| **–í–´–°–û–ö–ò–ô** | –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∏–º–±–∞–ª–∞–Ω—Å–æ–≤ –≤ Service | –í–´–°–û–ö–ò–ô | 30 –º–∏–Ω |
| **–°–†–ï–î–ù–ò–ô** | –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É–º–º | –°–†–ï–î–ù–ò–ô | 30 –º–∏–Ω |
| **–°–†–ï–î–ù–ò–ô** | –û–±—ä–µ–¥–∏–Ω–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç | –°–†–ï–î–ù–ò–ô | 15 –º–∏–Ω |
| **–ù–ò–ó–ö–ò–ô** | –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã —Å—Ç–æ–ª–±—Ü–æ–≤ | –ù–ò–ó–ö–ò–ô | 10 –º–∏–Ω |
| **–ù–ò–ó–ö–ò–ô** | –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å SQL –∑–∞–ø—Ä–æ—Å—ã | –ù–ò–ó–ö–ò–ô | 10 –º–∏–Ω |

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞:** –•–æ—Ä–æ—à–µ–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ –æ—Å–Ω–æ–≤–∞–Ω–∏–µ —Å –ª–æ–∫–∞–ª—å–Ω—ã–º–∏ –ø—Ä–æ–±–ª–µ–º–∞–º–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –Ω–∞—Ä—É—à–µ–Ω–∏—è–º–∏ —Å–ª–æ–µ–≤ –≤ UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö.

**–û—Ü–µ–Ω–∫–∞ –¥–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞:** 7/10
**–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º–∞—è –æ—Ü–µ–Ω–∫–∞ –ø–æ—Å–ª–µ:** 8.5/10

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ù–∞—á–∞—Ç—å —Å **–§–∞–∑—ã 1** (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è), –∑–∞—Ç–µ–º –ø–µ—Ä–µ–π—Ç–∏ –∫ **–§–∞–∑–µ 2** (–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è). –§–∞–∑–∞ 3 –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç–ª–æ–∂–µ–Ω–∞, –µ—Å–ª–∏ –≤—Ä–µ–º–µ–Ω–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ.

---

**–î–æ–∫—É–º–µ–Ω—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω:** Claude (AI Assistant)
**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞
**–í–µ—Ä—Å–∏—è:** 1.0
